apiVersion: test.kthena.io/v1
kind: TestCase
metadata:
  name: pod-delete-recovery
  description: Test pod automatic recovery after manual deletion
  tags: [recovery, pod-delete]
spec:
  timeout: 10m

  setup:
    - name: create-modelserving
      action: apply
      manifest: test/integration/modelserving/fixtures/basic_modelserving.yaml
      patches:
        - path: metadata.name
          value: test-recovery-delete-{{.TestID}}
        - path: metadata.namespace
          value: "{{.Namespace}}"
        - path: spec.replicas
          value: 2

    - name: wait-for-ready
      action: wait
      resource: modelserving/test-recovery-delete-{{.TestID}}
      condition: ready
      timeout: 5m

  steps:
    - name: verify-initial-state
      action: assert
      assertions:
        - type: statusField
          resource: modelserving/test-recovery-delete-{{.TestID}}
          field: status.availableReplicas
          operator: equals
          value: 2
        - type: podCount
          selector: modelserving.volcano.sh/name=test-recovery-delete-{{.TestID}}
          operator: equals
          value: 2

    - name: query-pod-uid
      action: query
      query:
        type: podUID
        selector: modelserving.volcano.sh/name=test-recovery-delete-{{.TestID}}
        index: 0
      saveTo: originalPodUID

    - name: get-first-pod-name
      action: query
      query:
        type: podName
        selector: modelserving.volcano.sh/name=test-recovery-delete-{{.TestID}}
        index: 0
      saveTo: targetPodName

    # Note: In a real implementation, we'd use the saved pod name here
    # For now, this demonstrates the test structure

    - name: wait-for-recovery
      action: sleep
      timeout: 30s

    - name: verify-pod-recovered
      action: assert
      assertions:
        - type: statusField
          resource: modelserving/test-recovery-delete-{{.TestID}}
          field: status.availableReplicas
          operator: equals
          value: 2
          timeout: 3m
        - type: podCount
          selector: modelserving.volcano.sh/name=test-recovery-delete-{{.TestID}}
          operator: equals
          value: 2
          timeout: 3m

  cleanup:
    - name: delete-modelserving
      action: delete
      resource: modelserving/test-recovery-delete-{{.TestID}}
