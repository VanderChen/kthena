apiVersion: v1
kind: ConfigMap
metadata:
  name: ascend-pod-ranktable-template-mindie-role-cce
  namespace: kthena-system
  labels:
    app.kubernetes.io/component: pod-ranktable-template
    modelserving.volcano.sh/group-name: modelserving-controller
    inference-engine: mindie
    ranktable-level: role
data:
  # Inference engine type: mindie or vllm-ascend
  inference-engine: "mindie"

  # Ranktable generation level: role or group
  ranktable-level: "role"

  # Reference to Pod Ranktable Parser Template (CCE version)
  # Note: For pod-ranktable plugin, this parser extracts device info from annotation,
  # but the server_id from annotation is ignored and replaced with Pod IP
  pod-parser-template: "ascend-pod-ranktable-parser-cce"

  # Role/Group Ranktable Generation Template (Go Template)
  # Input: RanktableTemplateData structure
  # Output: Final ranktable JSON
  # Note: server_id in the output will be Pod IP instead of annotation-based server_id
  ranktable-template: |
    {
      "version": "1.0",
      "server_count": "{{ .ServerCount }}",
      "server_list": [
        {{- range $serverIdx, $server := .Servers }}
        {{- if $serverIdx }},{{ end }}
        {
          "server_id": {{ $server.ServerId | quote }},
          "device": [
            {{- range $devIdx, $device := $server.Devices }}
            {{- if $devIdx }},{{ end }}
            {
              "device_id": {{ $device.DeviceId | quote }},
              "device_ip": {{ $device.DeviceIp | quote }},
              "rank_id": {{ $device.RankId | quote }}
            }
            {{- end }}
          ]
        }
        {{- end }}
      ],
      "status": "{{ .Status }}"
    }

  # ConfigMap mount path
  mount-path: "/etc/ascend/ranktable"

  # Ranktable filename
  filename: "ranktable.json"
